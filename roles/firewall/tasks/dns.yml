---
- name: Configure systemd-resolved
  template:
    src: resolved/resolved.conf
    dest: /etc/systemd/resolved.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart systemd-resolved
- name: Install DHCP server
  apt:
    name: dnsmasq
    state: latest
    install_recommends: false
- name: Create systemd dnsmasq.service.d overrides directory
  file:
    path: /etc/systemd/system/dnsmasq.service.d/
    state: directory
    mode: '0755'
- name: Override systemd settings
  copy:
    src: dnsmasq/10-priority.conf
    dest: /etc/systemd/system/dnsmasq.service.d/10-priority.conf
    owner: root
    group: root
    mode: '0644'
  notify: 
    - systemctl daemon-reload
    - restart dnsmasq 
- name: Template a file to /etc/dnsmasq.conf
  template:
    src: dnsmasq/dnsmasq.conf
    dest: /etc/dnsmasq.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart dnsmasq
- name: Template DHCP reservations
  template:
    src: dnsmasq/ethers
    dest: /etc/ethers
    owner: root
    group: root
    mode: '0644'
  notify: restart dnsmasq
- name: Template DNS hosts file
  template:
    src: dnsmasq/hosts.dnsmasq
    dest: /etc/hosts.dnsmasq
    owner: root
    group: root
    mode: '0644'
  notify: restart dnsmasq
- name: Enable systemd-resolved
  ignore_errors: true
  systemd:
    name: systemd-resolved
    enabled: yes
    state: started
    masked: no
- name: Enable dnsmasq
  systemd:
    name: dnsmasq
    enabled: yes
    state: started
    masked: no
- name: Install Unbound server
  apt:
    name: unbound
    state: latest
    install_recommends: false
- name: Install Unbound DNSSEC anchor updater
  apt:
    name: unbound-anchor
    state: latest
    install_recommends: false
- name: Template a file to /etc/unbound/unbound.conf.d/server.conf
  template:
    src: unbound/server.conf
    dest: /etc/unbound/unbound.conf.d/server.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart unbound
- name: Override systemd unbound settings
  copy:
    src: unbound/10-priority.conf
    dest: /etc/systemd/system/unbound.service.d/10-priority.conf
    owner: root
    group: root
    mode: '0644'
  notify: 
    - systemctl daemon-reload
    - restart unbound 
- name: Enable unbound
  systemd:
    name: unbound
    enabled: yes
    state: started
    masked: no